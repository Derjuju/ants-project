<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>Ants</title>
	<script src="phaser-ce/2.9.4/phaser.min.js"></script>
	<script src="js/ant.js"></script>
	<style type="text/css">
		body {
			margin: 0;
		}
	</style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(1000, 640, Phaser.CANVAS, '', { preload: preload, create: create, update: update, render: render });

var scores = {'brown':0,'red':0,'yellow':0,'black':0};
var scoreLabelBrown, scoreLabelRed, scoreLabelYellow, scoreLabelBlack;
var scoreTextBrown, scoreTextRed, scoreTextYellow, scoreTextBlack;

var tickWorld = 0;

var map;
var spriteLayer;

var antBrown;
var ants = [];

function preload () {	
	// charge map
	game.load.tilemap('map01', 'assets/tilemaps/maps/map01.json', null, Phaser.Tilemap.TILED_JSON);
	game.load.image('map-tiles', 'assets/tilemaps/tiles/background-map01.png');
	// charge sprites
    game.load.spritesheet('ant', 'assets/sprites/ants-spritesheet.png',32,32,-1,1,1); // key, sourcefile, framesize x, framesize y
}

function create () {	
	// la carte
	map = game.add.tilemap('map01');
	map.addTilesetImage('Map01', 'map-tiles');
	layer = map.createLayer('Ground');
	layer.resizeWorld();
	layer.position.set(100, 0);
	layer.fixedToCamera = false;
	
	spriteLayer = game.add.group();
	spriteLayer.position.set(100, 0);
	
		
	/*ant = game.add.sprite(0, 0, 'ant'); //create and position player
	ant.animations.add('walkVertical', [0,1,2], 10, true);  // (key, framesarray, fps,repeat)
	ant.animations.add('walkHorizontal', [8,9,10], 10, true);  // (key, framesarray, fps,repeat)
	
	ant.animations.play('walkHorizontal');
	ant.direction = "right";*/
	
	scoreLabelBrown = game.add.text(0, 0, 'score', { fontSize: '20px', fill: '#996530', boundsAlignH: "center", boundsAlignV: "middle" });
	scoreLabelBrown.setTextBounds(0, 0, 100, 20);
	scoreLabelRed = game.add.text(0, 0, 'score', { fontSize: '20px', fill: '#f00', boundsAlignH: "center", boundsAlignV: "middle" });
	scoreLabelRed.setTextBounds(900, 0, 100, 20);
	scoreLabelYellow = game.add.text(0, 0, 'score', { fontSize: '20px', fill: '#FF9900', boundsAlignH: "center", boundsAlignV: "middle" });
	scoreLabelYellow.setTextBounds(900, 600, 100, 20);
	scoreLabelBlack = game.add.text(0, 0, 'score', { fontSize: '20px', fill: '#fff', boundsAlignH: "center", boundsAlignV: "middle" });
	scoreLabelBlack.setTextBounds(0, 600, 100, 20);
	
	scoreTextBrown = game.add.text(0, 0, scores.brown, { fontSize: '20px', fill: '#996530', boundsAlignH: "center", boundsAlignV: "middle" });
	scoreTextBrown.setTextBounds(0, 20, 100, 20);
	scoreTextRed = game.add.text(0, 0, scores.red, { fontSize: '20px', fill: '#f00', boundsAlignH: "center", boundsAlignV: "middle" });
	scoreTextRed.setTextBounds(900, 20, 100, 20);
	scoreTextYellow = game.add.text(0, 0, scores.yellow, { fontSize: '20px', fill: '#FF9900', boundsAlignH: "center", boundsAlignV: "middle" });
	scoreTextYellow.setTextBounds(900, 620, 100, 20);
	scoreTextBlack = game.add.text(0, 0, scores.black, { fontSize: '20px', fill: '#fff', boundsAlignH: "center", boundsAlignV: "middle" });
	scoreTextBlack.setTextBounds(0, 620, 100, 20);
	
	scores.brown++;
	scoreTextBrown.setText(scores.brown);
	
	/*antBrown = new Ant(game, 1 * 16, 1 * 16, {
		"orientation" : "right",
		"speed" : 2
	});*/
	//antBrown = new Ant(game, 1 * 16, 1 * 16, {});
	//game.add.existing(antBrown);
	
	// lance première résolution de l'état du monde
	resolveWorldState();

}

function update() {
}

function render () {
}



/** debug **/
function deplaceAnt(direction) {
	var finalCell = resolveGridCellFromXY(antBrown.destination.x, antBrown.destination.y);	
	if (direction == 'top') {
		if (finalCell.cellY > 1) {
			finalCell.cellY -= 1;
		}
	}
	else if (direction == 'bottom') {
		if (finalCell.cellY < 20) {
			finalCell.cellY += 1;
		}
	}
	else if (direction == 'right') {
		if (finalCell.cellX < 25) {
			finalCell.cellX += 1;
		}
	}
	else if (direction == 'left') {
		if (finalCell.cellX > 1) {
			finalCell.cellX -= 1;
		}
	}
	antBrown.setDestination((finalCell.cellX*32)-16,(finalCell.cellY*32)-16);
}
function resolveGridCellFromXY(x,y) {
	var cellX = ((x-16)/32)+1;
	var cellY = ((y-16)/32)+1;
	return {cellX,cellY};
}
function resolveXYFromGridCell(cellX, cellY) {
	var x = (cellX * 32) -16;
	var y = (cellY * 32) -16;
	return {x,y};
}

var worldHistory = [
	{
		'ants' : [
			{
				'id' : 1,
				'family' : 'brown',				
				'type' : 'normal',
				'life' : 10,
				'move' : null,
				'action' : {
					'type' : 'spawn',
					'position' : [1,1]
				}
			}
		]
	},
	{
		'ants' : [
			{
				'id' : 1,
				'family' : 'brown',				
				'type' : 'normal',
				'life' : 10,
				'move' : [2,1],
				'action' : null
			},
			{
				'id' : 2,
				'family' : 'yellow',				
				'type' : 'normal',
				'life' : 10,
				'move' : null,
				'action' : {
					'type' : 'spawn',
					'position' : [25,20]
				}
			}
		]
	},
	{
		'ants' : [
			{
				'id' : 1,
				'family' : 'brown',				
				'type' : 'normal',
				'life' : 10,
				'move' : [3,1],
				'action' : null
			},
			{
				'id' : 2,
				'family' : 'yellow',				
				'type' : 'normal',
				'life' : 10,
				'move' : [24,20],
				'action' : null
			},
			{
				'id' : 3,
				'family' : 'red',				
				'type' : 'normal',
				'life' : 10,
				'move' : null,
				'action' : {
					'type' : 'spawn',
					'position' : [25,1]
				}
			}
		]
	},
	{
		'ants' : [
			{
				'id' : 1,
				'family' : 'brown',				
				'type' : 'normal',
				'life' : 10,
				'move' : [3,2],
				'action' : null
			},
			{
				'id' : 2,
				'family' : 'yellow',				
				'type' : 'normal',
				'life' : 10,
				'move' : [23,20],
				'action' : null
			},
			{
				'id' : 3,
				'family' : 'red',				
				'type' : 'normal',
				'life' : 10,
				'move' : [24,1],
				'action' : null
			}
		]
	},
	{
		'ants' : [
			{
				'id' : 1,
				'family' : 'brown',				
				'type' : 'normal',
				'life' : 10,
				'move' : [3,3],
				'action' : {
					'type' : 'death'
				}
			},
			{
				'id' : 2,
				'family' : 'yellow',				
				'type' : 'normal',
				'life' : 10,
				'move' : [23,19],
				'action' : {
					'type' : 'death'
				}
			}
		]
	}
];

var nbreSpritesToWait = 0;
function getNextTick() {
	console.log("----------------- getNextTick -----------------");
	tickWorld++;	
	resolveWorldState();	
}
function spriteTourHasEnded() {
	nbreSpritesToWait--;
	if(nbreSpritesToWait < 1) {
		setTimeout(getNextTick,1);
	}
}
function resolveWorldState() {
	console.log("resolveWorldState : "+tickWorld);
	nbreSpritesToWait = 0;
	if (worldHistory[tickWorld] != undefined) {
		var worldState = worldHistory[tickWorld];
		if (worldState.ants != undefined) {
			nbreSpritesToWait += worldState.ants.length;
			for(var i=0; i< worldState.ants.length; i++) {
				var ant = worldState.ants[i];
				// résolution des naissances
				if (ant.action != undefined && ant.action.type == "spawn") {
					var newAnt = new Ant(game, (ant.action.position[0] * 32 - 16), (ant.action.position[1] * 32 - 16), {
						"id" : ant.id,
						"family" : ant.family,
						"type" : ant.type,
						"life" : ant.life
					});	
					ants.push(newAnt);
					//game.add.existing(newAnt);
					spriteLayer.add(newAnt);
				    newAnt.events.onKilled.add(antIsKilled, this);
				}
				else {
					// retrouve la bonne fourmi et affecte lui son état
					for(var j=0; j<ants.length; j++) {
						if (ants[j].id == ant.id) {
							ants[j].updateState(ant);
							break;
						}
					}
				}
			}
		}
	} else {
		console.log("fin de l'histoire");
	}
}

function antIsKilled(ant) {
	for(var j=0; j<ants.length; j++) {
		if (ants[j].id == ant.id) {
			ants.splice(j,1);
			// détruit pour libération de la mémoire
			ant.destroy();
			break;
		}
	}		
}

</script>
<!--
<table style="float:right;">
	<tr>
		<td></td>
		<td><input type="button" value="haut" onClick="deplaceAnt('top');"></td>
		<td></td>
	</tr>
	<tr>
		<td><input type="button" value="gauche" onClick="deplaceAnt('left');"></td>
		<td></td>
		<td><input type="button" value="droite" onClick="deplaceAnt('right');"></td>
	</tr>
	<tr>
		<td></td>
		<td><input type="button" value="bas" onClick="deplaceAnt('bottom');"></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td><input type="button" value="Next Tick" onClick="getNextTick();"></td>
		<td></td>
	</tr>
</table>
//-->
</body>
</html>